{% extends 'base.html' %}

{% block title %}System Settings{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-cog"></i> System Settings</h1>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSettingModal">
            <i class="fas fa-plus"></i> Add Setting
        </button>
    </div>

    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
    {% endif %}

    <!-- Settings Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Value</th>
                            <th>Type</th>
                            <th>Public</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for setting in settings %}
                        <tr>
                            <td><code>{{ setting.key }}</code></td>
                            <td>
                                {% if setting.value|length > 50 %}
                                    {{ setting.value|truncatewords:10 }}
                                {% else %}
                                    {{ setting.value }}
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-info">{{ setting.data_type }}</span>
                            </td>
                            <td>
                                <span class="badge bg-{{ setting.is_public|yesno:'success,secondary' }}">
                                    {{ setting.is_public|yesno:'Yes,No' }}
                                </span>
                            </td>
                            <td>{{ setting.description|truncatewords:10 }}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editSetting('{{ setting.key }}', '{{ setting.value }}', '{{ setting.description }}', '{{ setting.data_type }}', {{ setting.is_public|yesno:'true,false' }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-muted">No settings found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Setting Modal -->
<div class="modal fade" id="addSettingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add/Edit Setting</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Key *</label>
                        <input type="text" name="key" id="setting_key" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Value *</label>
                        <textarea name="value" id="setting_value" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Data Type *</label>
                        <select name="data_type" id="setting_data_type" class="form-select" required>
                            <option value="string">String</option>
                            <option value="integer">Integer</option>
                            <option value="boolean">Boolean</option>
                            <option value="json">JSON</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" id="setting_description" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" name="is_public" id="setting_is_public" class="form-check-input">
                        <label class="form-check-label">Public (visible to tenants)</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Setting</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function editSetting(key, value, description, dataType, isPublic) {
    document.getElementById('setting_key').value = key;
    document.getElementById('setting_value').value = value;
    document.getElementById('setting_description').value = description;
    document.getElementById('setting_data_type').value = dataType;
    document.getElementById('setting_is_public').checked = isPublic;
    
    const modal = new bootstrap.Modal(document.getElementById('addSettingModal'));
    modal.show();
}
</script>
{% endblock %}
