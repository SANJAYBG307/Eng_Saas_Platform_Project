{% extends 'base.html' %}
{% load static %}

{% block title %}Super Admin Dashboard{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .metric-card.success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    .metric-card.warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .metric-card.info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
    }
    .metric-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    .chart-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .activity-item {
        padding: 15px;
        border-bottom: 1px solid #eee;
    }
    .activity-item:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h1 class="mb-4">
        <i class="fas fa-tachometer-alt"></i> Super Admin Dashboard
    </h1>

    <!-- Key Metrics Row 1 -->
    <div class="row">
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-label">Total Tenants</div>
                <div class="metric-value">{{ total_tenants }}</div>
                <small>{{ active_tenants }} Active</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card success">
                <div class="metric-label">Total Users</div>
                <div class="metric-value">{{ total_users }}</div>
                <small>{{ active_users }} Active</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card warning">
                <div class="metric-label">Subscriptions</div>
                <div class="metric-value">{{ active_subscriptions }}</div>
                <small>{{ trial_subscriptions }} Trials</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card info">
                <div class="metric-label">Revenue (30d)</div>
                <div class="metric-value">${{ recent_revenue|floatformat:0 }}</div>
                <small>Last 30 Days</small>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row">
        <div class="col-md-8">
            <div class="chart-container">
                <h5>System Metrics (Last 7 Days)</h5>
                <canvas id="metricsChart" height="80"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-container">
                <h5>
                    <i class="fas fa-ticket-alt"></i> Open Tickets
                    <span class="badge bg-danger float-end">{{ open_tickets }}</span>
                </h5>
                <a href="{% url 'company_admin:support_tickets' %}?status=open" class="btn btn-primary btn-sm mt-3">
                    View All Tickets
                </a>
            </div>
        </div>
    </div>

    <!-- Activity Row -->
    <div class="row">
        <div class="col-md-6">
            <div class="chart-container">
                <h5><i class="fas fa-building"></i> Recent Tenants</h5>
                <div class="list-group list-group-flush">
                    {% for tenant in recent_tenants %}
                    <div class="activity-item">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>{{ tenant.name }}</strong><br>
                                <small class="text-muted">{{ tenant.subdomain }}.yourdomain.com</small>
                            </div>
                            <div>
                                <span class="badge bg-{{ tenant.is_active|yesno:'success,secondary' }}">
                                    {{ tenant.is_active|yesno:'Active,Inactive' }}
                                </span><br>
                                <small class="text-muted">{{ tenant.created_at|date:'M d, Y' }}</small>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No recent tenants</p>
                    {% endfor %}
                </div>
                <a href="{% url 'company_admin:tenant_list' %}" class="btn btn-outline-primary btn-sm mt-3">
                    View All Tenants
                </a>
            </div>
        </div>

        <div class="col-md-6">
            <div class="chart-container">
                <h5><i class="fas fa-life-ring"></i> Recent Support Tickets</h5>
                <div class="list-group list-group-flush">
                    {% for ticket in recent_tickets %}
                    <div class="activity-item">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>{{ ticket.ticket_number }}</strong><br>
                                <small>{{ ticket.subject|truncatewords:10 }}</small>
                            </div>
                            <div>
                                <span class="badge bg-{{ ticket.status|yesno:'success,warning,danger' }}">
                                    {{ ticket.get_status_display }}
                                </span><br>
                                <small class="text-muted">{{ ticket.created_at|timesince }} ago</small>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No recent tickets</p>
                    {% endfor %}
                </div>
                <a href="{% url 'company_admin:support_tickets' %}" class="btn btn-outline-primary btn-sm mt-3">
                    View All Tickets
                </a>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-12">
            <div class="chart-container">
                <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
                <div class="row mt-3">
                    <div class="col-md-3">
                        <a href="{% url 'company_admin:tenant_list' %}" class="btn btn-outline-primary w-100">
                            <i class="fas fa-building"></i> Manage Tenants
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'company_admin:user_management' %}" class="btn btn-outline-success w-100">
                            <i class="fas fa-users"></i> Manage Users
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'company_admin:analytics_reporting' %}" class="btn btn-outline-info w-100">
                            <i class="fas fa-chart-line"></i> View Analytics
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'company_admin:system_settings' %}" class="btn btn-outline-warning w-100">
                            <i class="fas fa-cog"></i> System Settings
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart data from backend
    const chartData = {{ chart_data|safe }};
    
    const ctx = document.getElementById('metricsChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.map(d => d.date),
            datasets: [
                {
                    label: 'Active Tenants',
                    data: chartData.map(d => d.tenants),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Active Users',
                    data: chartData.map(d => d.users),
                    borderColor: '#38ef7d',
                    backgroundColor: 'rgba(56, 239, 125, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Daily Revenue ($)',
                    data: chartData.map(d => d.revenue),
                    borderColor: '#f5576c',
                    backgroundColor: 'rgba(245, 87, 108, 0.1)',
                    tension: 0.4,
                    yAxisID: 'revenue'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                },
                revenue: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
});
</script>
{% endblock %}
